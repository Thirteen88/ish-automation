version: '3.8'

services:
  # PostgreSQL Primary
  postgres-primary:
    image: bitnami/postgresql:15
    container_name: postgres-primary
    environment:
      - POSTGRESQL_DATABASE=ish_chat
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
      - POSTGRESQL_SYNCHRONOUS_COMMIT_MODE=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - PATRONI_NAME=postgres-primary
      - PATRONI_RESTAPI_CONNECT_ADDRESS=0.0.0.0:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-primary:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/bitnami/postgresql/data
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
    volumes:
      - postgres_primary_data:/bitnami/postgresql/data
      - ./config/postgresql.conf:/bitnami/postgresql/conf/postgresql.conf
      - ./config/patroni.yml:/opt/bitnami/patroni/conf/patroni.yml
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
      - "8008:8008"
    networks:
      - postgres-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica 1
  postgres-replica1:
    image: bitnami/postgresql:15
    container_name: postgres-replica1
    environment:
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_MASTER_HOST=postgres-primary
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
      - PATRONI_NAME=postgres-replica1
      - PATRONI_RESTAPI_CONNECT_ADDRESS=0.0.0.0:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-replica1:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/bitnami/postgresql/data
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
    volumes:
      - postgres_replica1_data:/bitnami/postgresql/data
      - ./config/postgresql.conf:/bitnami/postgresql/conf/postgresql.conf
      - ./config/patroni.yml:/opt/bitnami/patroni/conf/patroni.yml
    ports:
      - "5433:5432"
      - "8009:8008"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - postgres-primary
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica 2
  postgres-replica2:
    image: bitnami/postgresql:15
    container_name: postgres-replica2
    environment:
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_MASTER_HOST=postgres-primary
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
      - PATRONI_NAME=postgres-replica2
      - PATRONI_RESTAPI_CONNECT_ADDRESS=0.0.0.0:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-replica2:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/bitnami/postgresql/data
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replication_password}
    volumes:
      - postgres_replica2_data:/bitnami/postgresql/data
      - ./config/postgresql.conf:/bitnami/postgresql/conf/postgresql.conf
      - ./config/patroni.yml:/opt/bitnami/patroni/conf/patroni.yml
    ports:
      - "5434:5432"
      - "8010:8008"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - postgres-primary
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # etcd for Patroni consensus
  etcd:
    image: bitnami/etcd:3.5
    container_name: etcd
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_CLUSTER=etcd=http://0.0.0.0:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    volumes:
      - etcd_data:/bitnami/etcd
    ports:
      - "2379:2379"
      - "2380:2380"
    networks:
      - postgres-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgBouncer Connection Pooler
  pgbouncer:
    image: bitnami/pgbouncer:1.21
    container_name: pgbouncer
    environment:
      - PGBOUNCER_DATABASES=ish_chat=postgres-primary:5432,ish_chat_ro=postgres-replica1:5432,ish_chat_ro2=postgres-replica2:5432
      - PGBOUNCER_LISTEN_PORT=6432
      - PGBOUNCER_POOL_MODE=transaction
      - PGBOUNCER_SERVER_RESET_QUERY=DISCARD ALL
      - PGBOUNCER_IGNORE_STARTUP_PARAMETERS=extra_float_digits
      - PGBOUNCER_MAX_CLIENT_CONN=1000
      - PGBOUNCER_DEFAULT_POOL_SIZE=20
      - PGBOUNCER_MIN_POOL_SIZE=5
      - PGBOUNCER_RESERVE_POOL_SIZE=5
      - PGBOUNCER_RESERVE_POOL_TIMEOUT=5
      - PGBOUNCER_SERVER_LIFETIME=3600
      - PGBOUNCER_SERVER_IDLE_TIMEOUT=600
      - PGBOUNCER_STATS_USERS=stats
      - PGBOUNCER_STATS_PASSWORD=${PGBOUNCER_STATS_PASSWORD:-stats_password}
    volumes:
      - ./config/pgbouncer.ini:/opt/bitnami/pgbouncer/conf/pgbouncer.ini
      - ./config/users.txt:/opt/bitnami/pgbouncer/conf/users.txt
    ports:
      - "6432:6432"
      - "6433:6433"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - postgres-primary
      - postgres-replica1
      - postgres-replica2
    healthcheck:
      test: ["CMD", "pgbouncer", "--show-console"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HAProxy Load Balancer
  haproxy:
    image: haproxy:2.8
    container_name: haproxy
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    ports:
      - "5000:5000"  # Write operations (primary)
      - "5001:5001"  # Read operations (replicas)
      - "8404:8404"  # Stats page
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - pgbouncer
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8404/stats"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Caching
  redis:
    image: bitnami/redis:7.2
    container_name: redis
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis_password}
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    volumes:
      - redis_data:/bitnami/redis/data
    ports:
      - "6379:6379"
    networks:
      - postgres-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus for Monitoring
  prometheus:
    image: bitnami/prometheus:2.47
    container_name: prometheus
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/opt/bitnami/prometheus/data
    ports:
      - "9090:9090"
    networks:
      - postgres-network
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/opt/bitnami/prometheus/data'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

  # Grafana for Visualization
  grafana:
    image: bitnami/grafana:10.2
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin_password}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/opt/bitnami/grafana/data
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3000:3000"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - prometheus

  # PostgreSQL Exporter for Prometheus
  postgres-exporter:
    image: bitnami/postgres-exporter:0.14
    container_name: postgres-exporter
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:${POSTGRES_PASSWORD:-secure_password}@postgres-primary:5432/ish_chat?sslmode=disable
    ports:
      - "9187:9187"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - postgres-primary

  # PgBouncer Exporter for Prometheus
  pgbouncer-exporter:
    image: bitnami/pgbouncer-exporter:0.5
    container_name: pgbouncer-exporter
    environment:
      - PGBOUNCER_EXPORTER_DATA_SOURCE_NAME=postgres://stats:${PGBOUNCER_STATS_PASSWORD:-stats_password}@pgbouncer:6432/pgbouncer
    ports:
      - "9127:9127"
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - pgbouncer

  # Backup Service (WAL-E)
  backup:
    image: bitnami/postgresql:15
    container_name: postgres-backup
    environment:
      - POSTGRESQL_HOST=postgres-primary
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
      - POSTGRESQL_DATABASE=ish_chat
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - WALE_S3_PREFIX=${WALE_S3_PREFIX:-s3://ish-chat-backups/postgres}
      - WALE_WAL_SIZE=104857600  # 100MB
      - WALE_BACKUP_THRESHOLD_PERCENTAGE=30
    volumes:
      - ./scripts/backup.sh:/backup.sh
      - backup_data:/backups
    networks:
      - postgres-network
    restart: unless-stopped
    depends_on:
      - postgres-primary
    command: >
      sh -c "
      while true; do
        echo 'Starting backup process...'
        /backup.sh
        echo 'Backup completed. Waiting for next run...'
        sleep 3600
      done
      "

volumes:
  postgres_primary_data:
    driver: local
  postgres_replica1_data:
    driver: local
  postgres_replica2_data:
    driver: local
  etcd_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  backup_data:
    driver: local

networks:
  postgres-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16