global
    daemon
    maxconn 4096
    log stdout format raw local0
    stats socket /var/run/haproxy.sock mode 600 level admin

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-desc ISH Chat PostgreSQL Cluster

# Primary database for write operations
listen postgres_write
    bind *:5000
    mode tcp
    option tcplog
    option tcp-check
    balance first
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    server postgres-primary postgres-primary:5432 check inter 2s rise 2 fall 3
    server postgres-replica1 postgres-replica1:5432 check backup inter 2s rise 2 fall 3
    server postgres-replica2 postgres-replica2:5432 check backup inter 2s rise 2 fall 3

    # Health check with HTTP if Patroni API is available
    option httpchk OPTIONS /primary
    http-check expect status 200

# Read replicas for read operations (round-robin)
listen postgres_read
    bind *:5001
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    server postgres-replica1 postgres-replica1:5432 check inter 2s rise 2 fall 3
    server postgres-replica2 postgres-replica2:5432 check inter 2s rise 2 fall 3
    server postgres-primary postgres-primary:5432 check backup inter 2s rise 2 fall 3

# PgBouncer connections
listen pgbouncer_write
    bind *:6432
    mode tcp
    option tcplog
    option tcp-check
    balance first
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    server pgbouncer pgbouncer:6432 check inter 2s rise 2 fall 3

listen pgbouncer_read
    bind *:6433
    mode tcp
    option tcplog
    option tcp-check
    balance roundrobin
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    server pgbouncer pgbouncer:6432 check inter 2s rise 2 fall 3

# API endpoints for Patroni
listen patroni_api
    bind *:8008
    mode http
    option httplog
    balance roundrobin
    timeout client 30s
    timeout server 30s
    timeout connect 5s

    server patroni1 postgres-primary:8008 check
    server patroni2 postgres-replica1:8008 check
    server patroni3 postgres-replica2:8008 check

# Health check endpoints
listen health_check
    bind *:9000
    mode http
    option httplog
    http-request return status 200 content-type text/plain string "OK"

# Frontend for application connections
frontend ish_chat_frontend
    bind *:5432
    mode tcp
    option tcplog
    default_backend postgres_backend

backend postgres_backend
    mode tcp
    balance leastconn
    option tcp-check
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    # Write operations go to primary
    acl is_write_request req.payload(0,0) -m str -i INSERT UPDATE DELETE CREATE DROP ALTER
    use_server postgres-primary if is_write_request

    server postgres-primary postgres-primary:5432 check inter 2s rise 2 fall 3
    server postgres-replica1 postgres-replica1:5432 check inter 2s rise 2 fall 3
    server postgres-replica2 postgres-replica2:5432 check inter 2s rise 2 fall 3

# Admin interface for database management
listen admin
    bind *:8080
    mode http
    stats enable
    stats uri /admin
    stats refresh 10s
    stats admin if TRUE
    acl admin_allowed src 127.0.0.1 172.20.0.0/16
    http-request deny unless admin_allowed

# Redis connection
listen redis
    bind *:6379
    mode tcp
    option tcplog
    balance roundrobin
    timeout client 1h
    timeout server 1h
    timeout connect 5s

    server redis redis:6379 check inter 2s rise 2 fall 3

# Monitoring endpoints
listen monitoring
    bind *:9091
    mode http
    option httplog
    stats enable
    stats uri /monitoring
    stats refresh 30s
    stats show-desc ISH Chat Cluster Monitoring

# Custom error pages
errorfile 400 /etc/haproxy/errors/400.http
errorfile 403 /etc/haproxy/errors/403.http
errorfile 408 /etc/haproxy/errors/408.http
errorfile 500 /etc/haproxy/errors/500.http
errorfile 502 /etc/haproxy/errors/502.http
errorfile 503 /etc/haproxy/errors/503.http
errorfile 504 /etc/haproxy/errors/504.http

# Rate limiting for API endpoints
frontend api_rate_limit
    bind *:5000
    mode http
    option httplog

    # Rate limiting rules
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    default_backend postgres_api

backend postgres_api
    mode http
    balance roundrobin
    timeout client 30s
    timeout server 30s
    timeout connect 5s

    server api1 postgres-primary:8008 check
    server api2 postgres-replica1:8008 check
    server api3 postgres-replica2:8008 check

# SSL termination (uncomment for production)
# frontend ssl_frontend
#     bind *:443 ssl crt /etc/haproxy/ssl/ish-chat.pem
#     mode tcp
#     option tcplog
#     default_backend postgres_ssl
#
# backend postgres_ssl
#     mode tcp
#     balance leastconn
#     option tcp-check
#     timeout client 1h
#     timeout server 1h
#     timeout connect 5s
#
#     server postgres-primary postgres-primary:5432 check inter 2s rise 2 fall 3
#     server postgres-replica1 postgres-replica1:5432 check inter 2s rise 2 fall 3
#     server postgres-replica2 postgres-replica2:5432 check inter 2s rise 2 fall 3